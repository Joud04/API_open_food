<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Scanner</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header>
        <h1>üçè Fresh Food Scan</h1>
        <p>Recherchez vos produits pr√©f√©r√©s</p>
    </header>

    <div class="search-container">
        <div class="search-box">
            <input type="text" id="search" placeholder="Nutella, Coca, 327408..." onkeypress="handleEnter(event)">
            <button class="search-btn" onclick="search()">Chercher</button>
        </div>
    </div>

    <main>
        <div id="gallery"></div>

        <div id="product-detail">
            <div class="green-header">D√©tails du produit</div>
            <img id="d-img" style="max-height:200px; margin-bottom:20px;" src="">
            
            <h2 id="d-name">-</h2>
            <p style="color:#777">Marque : <span id="d-brand">-</span></p>

            <div style="display:flex; justify-content:center; gap:20px; margin: 20px 0;">
                <img id="d-nutri" height="50" src="">
                <img id="d-eco" height="50" src="">
            </div>

            <div style="border-top:1px solid #eee; padding-top:15px; text-align:left;">
                <strong>Infos / Allerg√®nes :</strong>
                <div id="d-allergens" class="badges"></div>
            </div>

            <button onclick="closeDetail()" style="margin-top:20px; padding:10px 20px; border:none; background:#333; color:white; border-radius:30px; cursor:pointer;">Retour</button>
        </div>
    </main>

    <script>
        const API = "http://localhost:3000/api";
        const gallery = document.getElementById('gallery');
        const detail = document.getElementById('product-detail');

        document.addEventListener('DOMContentLoaded', loadInitial);

        function handleEnter(e) { if(e.key === 'Enter') search(); }

        function showSkeletons() {
            gallery.innerHTML = '';
            detail.style.display = 'none';
            gallery.style.display = 'grid';
            for(let i=0; i<8; i++) gallery.innerHTML += `<div class="skeleton"></div>`;
        }

        async function loadInitial() {
            showSkeletons();
            try {
                const res = await fetch(`${API}/initial`);
                const products = await res.json();
                displayGallery(products);
            } catch(e) {
                gallery.innerHTML = "<p style='text-align:center'>Erreur connexion serveur...</p>";
            }
        }

        async function search() {
            const val = document.getElementById('search').value;
            if(!val) return;
            
            showSkeletons();
            try {
                const res = await fetch(`${API}/search?q=${val}`);
                const products = await res.json();
                
                if(products.length === 1) showProduct(products[0]);
                else displayGallery(products);
            } catch(e) {
                gallery.innerHTML = "<p style='text-align:center'>Aucun r√©sultat.</p>";
            }
        }

        function displayGallery(products) {
            gallery.innerHTML = '';
            if(!products || products.length === 0) {
                gallery.innerHTML = "<p style='text-align:center'>Aucun produit trouv√©.</p>";
                return;
            }

            products.forEach(p => {
                const img = p.image_front_small_url || p.image_front_url || 'https://placehold.co/150x150?text=No+Image';
                const card = document.createElement('div');
                card.className = 'card';
                card.onclick = () => showProduct(p);
                card.innerHTML = `
                    <img src="${img}" loading="lazy" onerror="this.src='https://placehold.co/150x150?text=Error'">
                    <h4>${p.product_name || 'Inconnu'}</h4>
                    <small>${p.brands || ''}</small>
                `;
                gallery.appendChild(card);
            });
        }

        function showProduct(p) {
            gallery.style.display = 'none';
            detail.style.display = 'block';

            document.getElementById('d-img').src = p.image_front_url || p.image_front_small_url || '';
            document.getElementById('d-name').innerText = p.product_name || "Nom inconnu";
            document.getElementById('d-brand').innerText = p.brands || "-";

            const n = p.nutriscore_grade ? p.nutriscore_grade.toLowerCase() : 'unknown';
            const e = p.ecoscore_grade ? p.ecoscore_grade.toLowerCase() : 'unknown';
            document.getElementById('d-nutri').src = `https://static.openfoodfacts.org/images/misc/nutriscore-${n}.svg`;
            document.getElementById('d-eco').src = `https://static.openfoodfacts.org/images/attributes/ecoscore-${e}.svg`;

            const badges = document.getElementById('d-allergens');
            badges.innerHTML = (p.allergens_tags || []).map(t => 
                `<span class="badge">${t.replace('en:', '').replace('fr:', '')}</span>`
            ).join('');
        }

        function closeDetail() {
            detail.style.display = 'none';
            gallery.style.display = 'grid';
        }
    </script>
</body>
</html>